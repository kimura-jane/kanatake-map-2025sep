<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>かなだけMAP 2025年9月</title>

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
    defer
  ></script>

  <!-- 出店データ（グローバル window.spots を定義） -->
  <script src="spots.js" defer></script>

  <style>
    /* 画面全体に地図 */
    html, body { height: 100%; margin: 0; background:#faf9f3; }
    #map { position: fixed; inset: 0; }

    /* 右下のリストカード（小さめ） */
    .spot-card {
      position: fixed;
      right: 12px;
      bottom: 12px;
      width: min(78vw, 320px);
      max-height: 42vh;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      background: rgba(255,255,255,0.92);
      backdrop-filter: blur(3px);
      border-radius: 14px;
      box-shadow: 0 6px 22px rgba(0,0,0,0.18);
      padding: 10px 12px;
      pointer-events: auto;
      font-family: "Hiragino Kaku Gothic ProN", "Yu Gothic", system-ui, -apple-system, sans-serif;
      color:#333;
    }
    .spot-title {
      font-size: 13px;
      font-weight: 700;
      letter-spacing: .02em;
      margin: 0 0 6px;
    }
    .spot-list {
      list-style: decimal;
      padding-left: 22px;  /* 番号の桁が増えても綺麗に */
      margin: 0;
      font-size: 13px;     /* ← 小さく（約半分弱） */
      line-height: 1.35;
    }
    .spot-list li { 
      margin: 6px 0; 
      position: relative;
    }
    .spot-list .name { margin-right: .4em; }
    .badge {
      display: inline-block;
      font-size: 11px;     /* ← バッジも小さく */
      padding: 2px 8px;
      border-radius: 999px;
      background: #fde7a8;
      color: #5a4b1a;
      vertical-align: middle;
    }

    /* スクロールバー控えめ（iOSは自動） */
    .spot-card::-webkit-scrollbar { width: 8px; }
    .spot-card::-webkit-scrollbar-thumb {
      background: rgba(0,0,0,.18); border-radius: 8px;
    }
  </style>
</head>
<body>
  <div id="map" role="region" aria-label="地図"></div>

  <!-- 右下の常時表示リスト（番号は <ol> に任せる） -->
  <section class="spot-card" id="listCard" aria-live="polite">
    <p class="spot-title">出店リスト（タップで地図）</p>
    <ol class="spot-list" id="spotList"></ol>
  </section>

  <script>
    // Leaflet 初期化
    const map = L.map('map', { zoomControl: true }).setView([35.68, 139.76], 10);
    L.tileLayer(
      "https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png",
      { attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; CARTO' }
    ).addTo(map);

    // おにぎりアイコン
    const onigiriIcon = L.icon({
      iconUrl: 'icon.png',    // リポジトリ直下のアイコンファイル
      iconSize: [44, 44],     // 少し小さめ
      iconAnchor: [22, 32],
      popupAnchor: [0, -28]
    });

    // spots.js 読み込みチェック
    const data = (window.spots || []);
    if (!Array.isArray(data) || data.length === 0) {
      console.warn('spots が見つからないか、空配列です');
    }

    // マーカーとリスト生成（※番号文字列は付けない）
    const list = document.getElementById('spotList');
    const markers = [];

    data.forEach((s, idx) => {
      if (typeof s.lat === 'number' && typeof s.lng === 'number') {
        const m = L.marker([s.lat, s.lng], { icon: onigiriIcon })
          .addTo(map)
          .bindPopup(`
            <strong>${s.name}</strong><br>
            ${s.date}${s.time ? ' ・ ' + s.time : ''}<br>
            <a href="https://www.google.com/maps?q=${s.lat},${s.lng}" target="_blank" rel="noopener">Googleマップで開く</a>
          `);
        markers.push(m);
      }

      const li = document.createElement('li');
      li.innerHTML = `
        <span class="name">${s.name}</span>
        <span class="badge">${s.date}</span>
      `;
      li.addEventListener('click', () => {
        if (markers[idx]) {
          map.setView(markers[idx].getLatLng(), 12, { animate: true });
          markers[idx].openPopup();
        }
      });
      list.appendChild(li);
    });

    // 初期表示：東京湾周辺が見える程度
    if (markers.length) {
      const g = L.featureGroup(markers);
      map.fitBounds(g.getBounds().pad(0.2));
    }
  </script>
</body>
</html>
