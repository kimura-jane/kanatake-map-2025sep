<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>出店マップ 2025年9月</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  html, body { height:100%; margin:0; }
  #map { height:100%; width:100%; }

  /* ポップな淡色 × 手書き風 */
  .leaflet-container { background:#f7f6f3; }
  .leaflet-popup-content-wrapper {
    border-radius:14px;
    border:2px solid #ffd5a7;
    box-shadow: 0 8px 20px rgba(0,0,0,.12);
  }
  .leaflet-popup-content { font-family: "Hiragino Kaku Gothic ProN", "Yu Gothic", Meiryo, sans-serif; }
  .popup-title { font-weight:700; font-size:18px; margin:0 0 4px; }
  .popup-date { color:#666; margin:0 0 6px; font-size:14px; }
  .popup-link a {
    display:inline-block; padding:6px 10px; border-radius:10px;
    background:#ffe9c9; text-decoration:none; color:#333; font-weight:600;
    border:1px solid #ffc98f;
  }

  /* 右下の固定リスト（常時表示） */
  #listBox {
    position: fixed; right: 10px; bottom: 12px;
    width: 44vw; max-width: 340px; min-width: 240px;
    max-height: 44vh; overflow: auto;
    background: rgba(255,255,255,.95);
    border: 2px solid #ffd5a7; border-radius:16px;
    box-shadow: 0 8px 20px rgba(0,0,0,.12);
    -webkit-backdrop-filter: blur(4px); backdrop-filter: blur(4px);
    font-family: "Hiragino Kaku Gothic ProN", "Yu Gothic", Meiryo, sans-serif;
  }
  #listBox h3 {
    margin:10px 12px 0; font-size:15px; letter-spacing:.02em;
  }
  #list {
    list-style: decimal inside;
    margin: 8px 12px 12px; padding:0;
    font-size: 12.5px; line-height: 1.4;
  }
  #list li { margin: 6px 0; }

  /* スマホ最適化 */
  @media (max-width:480px) {
    #listBox { width: 72vw; max-width:none; }
    .popup-title { font-size:16px; }
  }
</style>
</head>
<body>
  <div id="map" role="application" aria-label="出店マップ"></div>

  <!-- 右下：出店リスト（番号だけ・地図は入れない） -->
  <aside id="listBox">
    <h3>出店リスト（タップで地図）</h3>
    <ol id="list"></ol>
  </aside>

  <!-- データ（spots.js）を先に読む：※ファイル名は小文字で『spots.js』 -->
  <script src="./spots.js?v=2025-09-06"></script>

  <script>
  // ========== ベースマップ ==========
  const map = L.map('map', { zoomControl:true, attributionControl:true }).setView([35.78,139.76], 10);
  L.tileLayer(
    'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
    { attribution: '&copy; <a href="https://carto.com/attributions">CARTO</a> &copy; OSM' }
  ).addTo(map);

  // ========== オニギリアイコン ==========
  const onigiriIcon = L.icon({
    iconUrl: './icon.png',
    iconSize: [44,44],
    iconAnchor: [22,22],
    popupAnchor: [0,-12]
  });

  // ========== ユーティリティ ==========
  const fmtDate = s => s.replace(/^(\d{2})\/(\d{2})$/, '9/$2'); // 9月固定の簡易表示
  const gmapsDirect = (lat,lng,label) =>
    `https://www.google.com/maps?q=${lat},${lng}(${encodeURIComponent(label)})`;

  // Nominatim での簡易ジオコーディング（localStorage にキャッシュ）
  async function geocodeIfNeeded(p) {
    if (typeof p.lat === 'number' && typeof p.lng === 'number') return p;
    const key = `geo:${p.name}|${p.addr||''}`;
    const cached = localStorage.getItem(key);
    if (cached) {
      try { const {lat,lng}=JSON.parse(cached); p.lat=lat; p.lng=lng; return p; } catch {}
    }
    const q = encodeURIComponent(`${p.name} ${p.addr||''} 日本`);
    const url = `https://nominatim.openstreetmap.org/search?format=jsonv2&limit=1&accept-language=ja&q=${q}`;
    try {
      const res = await fetch(url, { headers: { 'Accept':'application/json' }});
      const js = await res.json();
      if (js && js[0]) {
        p.lat = parseFloat(js[0].lat); p.lng = parseFloat(js[0].lon);
        localStorage.setItem(key, JSON.stringify({lat:p.lat, lng:p.lng}));
      }
    } catch(e){}
    return p;
  }

  // ========== メイン ==========
  (async () => {
    const DATA = (Array.isArray(window.spots)? window.spots : []);
    const listEl = document.getElementById('list');

    if (!DATA.length) {
      listEl.innerHTML = '<li style="color:#c00">データが読み込めませんでした。<code>spots.js</code> と <code>window.spots</code> を確認してください。</li>';
      return;
    }

    // 並び替え（日付昇順）
    DATA.sort((a,b)=> a.date.localeCompare(b.date));

    // リストとマーカー
    let bounds = [];
    let index = 0;
    for (const pRaw of DATA) {
      const p = await geocodeIfNeeded({...pRaw});
      index++;

      // リスト（右下）
      const li = document.createElement('li');
      li.textContent = `${p.name}（${fmtDate(p.date)}${p.time? '・'+p.time:''}）`;
      li.style.cursor = 'pointer';
      li.title = '地図を移動';
      li.addEventListener('click', ()=> {
        if (typeof p.lat === 'number' && typeof p.lng === 'number') {
          map.setView([p.lat,p.lng], 14, {animate:true});
        }
      });
      listEl.appendChild(li);

      // マーカー（座標があれば設置）
      if (typeof p.lat === 'number' && typeof p.lng === 'number') {
        const m = L.marker([p.lat,p.lng], { icon: onigiriIcon }).addTo(map);
        const link = gmapsDirect(p.lat,p.lng,p.name);
        m.bindPopup(
          `<p class="popup-title">${p.name}</p>` +
          `<p class="popup-date">${fmtDate(p.date)}${p.time? '・'+p.time:''}</p>` +
          `<p class="popup-link"><a target="_blank" rel="noopener" href="${link}">Googleマップで開く</a></p>`
        );
        bounds.push([p.lat,p.lng]);
      }
    }

    // 全体表示調整
    if (bounds.length) {
      const b = L.latLngBounds(bounds);
      map.fitBounds(b.pad(0.2));
    }
  })();
  </script>
</body>
</html>
